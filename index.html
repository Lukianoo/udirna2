<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Panel ud√≠rny</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- JustGage -->
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/justgage.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: Segoe UI, Tahoma, sans-serif;
  background: #121212;
  color: #fff;
  transition: background 0.4s;
}

h1.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 40px;
  font-size: 34px;
}

#clock { font-size: 20px; opacity: 0.8; }

#temp-status {
  text-align: center;
  font-size: 32px;
  font-weight: bold;
  margin: 0 40px 20px;
  padding: 12px;
  border-radius: 12px;
  background: linear-gradient(90deg,#222,#333);
}

.status-low { color:#3399ff; }
.status-ok { color:#33cc33; }
.status-high { color:#ff3333; }

.panel {
  display: grid;
  grid-template-columns: 1fr 1.5fr 1fr;
  gap: 30px;
  padding: 20px 40px;
  max-width: 1400px;
  margin: auto;
}

.gauge {
  background: #1e1e1e;
  border-radius: 25px;
  padding: 15px;
  text-align: center;
  box-shadow: 0 4px 25px rgba(0,0,0,0.6);
}

.gauge.big { transform: scale(1.15); }
.label { opacity:0.85; }

.history {
  max-width: 1400px;
  margin: 40px auto;
  padding: 0 40px;
}

.alarm-settings {
  text-align:center;
  margin:30px 0;
}

.alarm-settings input,
.alarm-settings select {
  width:70px;
  font-size:16px;
  margin:0 5px;
}

.alarm-settings button {
  margin-left:10px;
  padding:6px 14px;
  font-size:16px;
}

footer {
  text-align:center;
  opacity:0.6;
  margin:20px;
}

#fullscreen-btn {
  position:fixed;
  bottom:20px;
  right:20px;
  padding:10px 18px;
  font-size:16px;
}

@media (max-width: 900px) {
  .panel { grid-template-columns:1fr; }
  .gauge.big { transform:scale(1); }
}
</style>
</head>

<body>

<h1 class="header">üî• Panel ud√≠rny <span id="clock">--:--:--</span></h1>
<div id="temp-status">ƒåek√°m na data‚Ä¶</div>

<div class="panel">
  <div class="gauge">
    <div id="gauge-left" style="height:220px"></div>
    <div class="label">WiFi sign√°l [%]</div>
  </div>

  <div class="gauge big">
    <div id="gauge-center" style="height:280px"></div>
    <div class="label">Teplota v ud√≠rnƒõ [¬∞C]</div>
  </div>

  <div class="gauge">
    <div id="gauge-right" style="height:220px"></div>
    <div class="label">Venkovn√≠ teplota [¬∞C]</div>
  </div>
</div>

<div class="history">
  <div class="gauge">
    <h2>üìà Historie teploty ‚Äì posledn√≠ch 10 hodin</h2>
    <canvas id="historyChart" height="120"></canvas>
  </div>
</div>

<div class="alarm-settings">
Min <input id="alarm-min" type="number"> ¬∞C
<select id="alarm-sound-min">
  <option value="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">Alarm</option>
  <option value="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">Beep</option>
</select>
Max <input id="alarm-max" type="number"> ¬∞C
<select id="alarm-sound-max">
  <option value="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">Alarm</option>
  <option value="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">Beep</option>
</select>
<button onclick="saveAlarm()">Ulo≈æit</button>
<button onclick="testAlarm()">Test</button>
</div>

<button id="fullscreen-btn" onclick="toggleFull()">Full</button>

<footer>
<div id="update-time">---</div>
</footer>

<script>
/* ====== KONFIG ====== */
const CHANNEL_MAIN = "260804";
const CHANNEL_OUT = "231269";

/* ====== GAUGE ====== */
const gaugeLeft   = new JustGage({id:"gauge-left",min:0,max:100,value:0});
const gaugeCenter = new JustGage({id:"gauge-center",min:0,max:120,value:0});
const gaugeRight  = new JustGage({id:"gauge-right",min:-30,max:40,value:0});

/* ====== ALARM ====== */
let alarmActive = false;
let alarmMin = 0;
let alarmMax = 120;
let alarmSoundMin, alarmSoundMax;

/* ====== GRAF ====== */
let historyChart = null;

/* ====== ELEMENTY ====== */
const alarmMinInput = document.getElementById("alarm-min");
const alarmMaxInput = document.getElementById("alarm-max");
const alarmSoundMinSelect = document.getElementById("alarm-sound-min");
const alarmSoundMaxSelect = document.getElementById("alarm-sound-max");

/* ====== ALARM STORAGE ====== */
function loadSavedAlarm() {
  const s = localStorage.getItem("alarm");
  if (!s) return;
  const a = JSON.parse(s);
  alarmMin = a.min;
  alarmMax = a.max;
  alarmSoundMin = a.smin;
  alarmSoundMax = a.smax;
  alarmMinInput.value = alarmMin;
  alarmMaxInput.value = alarmMax;
  alarmSoundMinSelect.value = alarmSoundMin;
  alarmSoundMaxSelect.value = alarmSoundMax;
}

function saveAlarm() {
  alarmMin = +alarmMinInput.value;
  alarmMax = +alarmMaxInput.value;
  alarmSoundMin = alarmSoundMinSelect.value;
  alarmSoundMax = alarmSoundMaxSelect.value;
  localStorage.setItem("alarm", JSON.stringify({
    min:alarmMin, max:alarmMax,
    smin:alarmSoundMin, smax:alarmSoundMax
  }));
}

function play(sound) {
  new Audio(sound).play();
}

function testAlarm() {
  play(alarmSoundMin);
  setTimeout(()=>play(alarmSoundMax), 1000);
}

/* ====== DATA ====== */
async function loadData() {
  try {
    const r1 = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_MAIN}/feeds/last.json`);
    const d1 = await r1.json();

    const temp = parseFloat(d1.field1);
    const wifi = parseFloat(d1.field2);

    gaugeCenter.refresh(temp);
    gaugeLeft.refresh(wifi);

    const r2 = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_OUT}/feeds/last.json`);
    const d2 = await r2.json();
    gaugeRight.refresh(parseFloat(d2.field4));

    document.getElementById("update-time").innerText =
      "Posledn√≠ aktualizace: " + new Date(d1.created_at).toLocaleString("cs-CZ");

    const st = document.getElementById("temp-status");
    st.className = "";

    if (temp < alarmMin) {
      st.innerText = "N√≠zk√° teplota";
      st.classList.add("status-low");
      document.body.style.background="#001a33";
      if (!alarmActive) { play(alarmSoundMin); alarmActive = true; }
    }
    else if (temp > alarmMax) {
      st.innerText = "Vysok√° teplota!";
      st.classList.add("status-high");
      document.body.style.background="#2b0000";
      if (!alarmActive) { play(alarmSoundMax); alarmActive = true; }
    }
    else {
      st.innerText = "Ide√°ln√≠ teplota";
      st.classList.add("status-ok");
      document.body.style.background="#121212";
      alarmActive = false;
    }

  } catch {
    document.getElementById("temp-status").innerText = "‚ö†Ô∏è Data nedostupn√°";
    alarmActive = false;
  }
}

/* ====== HISTORIE 10 h ====== */
async function loadHistory() {
  try {
    const res = await fetch(
      `https://api.thingspeak.com/channels/${CHANNEL_MAIN}/feeds.json?results=600`
    );
    const data = await res.json();

    const labels = [];
    const values = [];

    data.feeds.forEach(f => {
      if (f.field1) {
        labels.push(new Date(f.created_at).toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"}));
        values.push(parseFloat(f.field1));
      }
    });

    renderChart(labels, values);
  } catch {
    console.warn("Historie se nepoda≈ôila naƒç√≠st");
  }
}

function renderChart(labels, values) {
  const ctx = document.getElementById("historyChart").getContext("2d");

  if (historyChart) {
    historyChart.data.labels = labels;
    historyChart.data.datasets[0].data = values;
    historyChart.update();
    return;
  }

  historyChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Teplota [¬∞C]",
        data: values,
        borderWidth: 2,
        tension: 0.25,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color:"#fff" } }
      },
      scales: {
        x: { ticks: { color:"#ccc" }, grid:{color:"#333"} },
        y: { ticks: { color:"#ccc" }, grid:{color:"#333"} }
      }
    }
  });
}

/* ====== OSTATN√ç ====== */
function toggleFull() {
  document.fullscreenElement
    ? document.exitFullscreen()
    : document.documentElement.requestFullscreen();
}

function clock() {
  document.getElementById("clock").innerText =
    new Date().toLocaleTimeString("cs-CZ");
}

/* ====== START ====== */
loadSavedAlarm();
loadData();
loadHistory();

setInterval(loadData, 15000);
setInterval(loadHistory, 300000); // 5 minut
clock();
setInterval(clock, 1000);
</script>

</body>
</html>

