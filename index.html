<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ud√≠rna ‚Äì ≈ò√≠dic√≠ panel</title>

<style>
body{
  background:radial-gradient(circle at top,#2a2a2a,#000);
  color:#eee;
  font-family:Arial,sans-serif;
  margin:0;
}
#fs_btn_container{text-align:center;background:#111;padding:8px;}
#fs_btn{
  font-size:18px;padding:8px 15px;border-radius:8px;
  border:none;background:#ff7800;font-weight:bold;cursor:pointer;
}
#container{
  display:flex;flex-wrap:wrap;justify-content:center;
  align-items:flex-start;gap:20px;margin-top:20px;padding:10px;
}
.box{
  background:rgba(0,0,0,.65);
  border-radius:18px;
  box-shadow:0 0 30px rgba(255,120,0,.35);
  padding:15px;text-align:center;
  flex:1 1 300px;max-width:520px;
}
.gauge{width:280px;height:280px;}
.gauge.big{width:420px;height:420px;}
.state,.time{text-align:center;width:100%}
.time{color:#00d9ff;font-size:20px}
#wifi_time{font-size:28px}
.ok{color:#00ff66}
.bad{color:#ff3333}
.blink{animation:blink 1s infinite}
@keyframes blink{50%{opacity:.3}}
input,button{width:90%;padding:6px;border-radius:6px;margin-top:6px}
</style>
</head>

<body>

<div id="fs_btn_container">
  <button id="fs_btn">Fullscreen</button>
</div>

<div id="container">

<div class="box">
  <div id="rssi_gauge" class="gauge"></div>
  <div id="signal_state" class="state"></div>
  <div id="wifi_time" class="time"></div>
</div>

<div class="box">
  <div id="temp_gauge" class="gauge big"></div>
  <div id="smoke_state" class="state"></div>
  <hr>
  <div>Min alarm (¬∞C)</div>
  <input id="temp_min" type="number" value="75">
  <label><input type="checkbox" id="sound_enable" checked> üîî P√≠pnut√≠</label>
  <div>Max alarm (¬∞C)</div>
  <input id="temp_max" type="number" value="85">
</div>

<div class="box">
  <div id="temp2_gauge" class="gauge"></div>
  <div class="state">üå°Ô∏è Teplota venku</div>
</div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
/* ===== SOUND (CHROME SAFE) ===== */
let audioCtx=null;
function beep(f){
  if(!sound_enable.checked) return;
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  }
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=f;
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.2,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.25);
  o.start(); o.stop(audioCtx.currentTime+0.25);
}

/* ===== GAUGE ===== */
class Gauge{
  constructor(el,min,max,unit,main=false){
    this.min=min;this.max=max;this.main=main;
    el.innerHTML=`
    <svg viewBox="0 0 200 200">
      <defs>
        <linearGradient id="grad" x1="0" y1="1" x2="1" y2="0">
          <stop offset="0%" stop-color="#004cff"/>
          <stop offset="60%" stop-color="#3399ff"/>
          <stop offset="100%" stop-color="#ff3333"/>
        </linearGradient>
      </defs>
      <circle cx="100" cy="100" r="85" fill="#111"/>
      ${main?`<path id="band" stroke="url(#grad)" stroke-width="14" fill="none" opacity=".35"/>`:``}
      <path id="arc" stroke="#00f" stroke-width="5" fill="none"/>
      <g id="scale"></g>
      <line id="needle" x1="100" y1="100" x2="100" y2="25" stroke="#fff" stroke-width="4"/>
      <text id="val" x="100" y="130" fill="#fff" font-size="30" text-anchor="middle">0</text>
      <text x="100" y="155" fill="#aaa" font-size="16" text-anchor="middle">${unit}</text>
    </svg>`;
    this.svg=el.querySelector("svg");
    this.arc=el.querySelector("#arc");
    this.needle=el.querySelector("#needle");
    this.val=el.querySelector("#val");
    this.band=el.querySelector("#band");
    this.scale=el.querySelector("#scale");
    this.drawScale();
    if(main) this.drawBand();
  }

  polar(v,r){
    let a=(v-this.min)/(this.max-this.min)*Math.PI;
    return [100+r*Math.sin(a),100-r*Math.cos(a)];
  }

  drawScale(){
    for(let v=this.min;v<=this.max;v+=10){
      let [x1,y1]=this.polar(v,72);
      let [x2,y2]=this.polar(v,82);
      let [xt,yt]=this.polar(v,60);
      this.scale.innerHTML+=`
      <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#666"/>
      <text x="${xt}" y="${yt+4}" fill="#aaa" font-size="10" text-anchor="middle">${v}</text>`;
    }
  }

  drawBand(){
    let [x,y]=this.polar(this.max,85);
    this.band.setAttribute("d",`M 15 100 A 85 85 0 0 1 ${x} ${y}`);
  }

  set(v){
    v=Math.max(this.min,Math.min(this.max,v));
    this.val.textContent=v.toFixed(1);
    let a=(v-this.min)/(this.max-this.min)*180-90;
    this.needle.setAttribute("transform",`rotate(${a} 100 100)`);
    let [x,y]=this.polar(v,85);
    this.arc.setAttribute("d",`M 15 100 A 85 85 0 0 1 ${x} ${y}`);
  }
}

/* ===== INIT ===== */
let tempGauge,rssiGauge,temp2Gauge,lastTemp=null;

function init(){
  tempGauge=new Gauge(temp_gauge,0,120,"¬∞C",true);
  rssiGauge=new Gauge(rssi_gauge,0,100,"%");
  temp2Gauge=new Gauge(temp2_gauge,-30,50,"¬∞C");

  setInterval(load,15000);
  setInterval(()=>wifi_time.innerHTML="üïí "+new Date().toLocaleTimeString(),1000);
  load();
}

function load(){
  $.getJSON("https://api.thingspeak.com/channels/260804/feed/last.json?api_key=JXC3WDDU4WH71K93",d=>{
    let t=parseFloat(d.field1);
    let s=parseFloat(d.field2);
    if(!isNaN(t)){
      tempGauge.set(t);
      if(lastTemp!==null && lastTemp<=temp_max.value && t>temp_max.value) beep(600);
      temp_gauge.classList.toggle("blink",t>temp_max.value);
      smoke_state.textContent=t>temp_max.value?"‚ö†Ô∏è P≈òEH≈ò√ÅT√ç":"üî• OK";
      lastTemp=t;
    }
    if(!isNaN(s)){
      rssiGauge.set(s);
      signal_state.textContent=s>50?"üì∂ Sign√°l OK":"‚ö†Ô∏è Slab√Ω sign√°l";
    }
  });
  $.getJSON("https://api.thingspeak.com/channels/231269/feed/last.json",d=>{
    let t2=parseFloat(d.field4);
    if(!isNaN(t2)) temp2Gauge.set(t2);
  });
}

fs_btn.onclick=()=>document.fullscreenElement
 ?document.exitFullscreen()
 :document.documentElement.requestFullscreen();

init();
</script>
</body>
</html>
