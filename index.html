<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Panel udÃ­rny</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- JustGage -->
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/justgage.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Tahoma,sans-serif;
  background:#121212;
  color:#fff;
}
h1.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:20px 40px;
  font-size:36px;
}
#clock{font-size:20px;opacity:.8}

#temp-status{
  text-align:center;
  font-size:32px;
  font-weight:bold;
  margin-bottom:15px;
}

.status-low{color:#3399ff}
.status-ok{color:#33cc33}
.status-high{color:#ff3333}

.panel{
  display:grid;
  grid-template-columns:1fr 1.5fr 1fr;
  gap:25px;
  padding:0 40px;
  max-width:1400px;
  margin:auto;
}

.gauge{
  background:#1e1e1e;
  border-radius:22px;
  padding:15px;
  text-align:center;
}

.gauge.big{transform:scale(1.15)}
.label{opacity:.8;margin-top:6px}

.history{
  margin-top:10px;
  background:#111;
  border-radius:12px;
  padding:6px;
}
.history canvas{
  height:140px!important;
  width:100%!important;
}

#fullscreen-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  padding:10px 18px;
  font-size:16px;
}

footer{
  text-align:center;
  opacity:.6;
  margin:10px;
}
</style>
</head>

<body>

<h1 class="header">ðŸ”¥ Panel udÃ­rny <span id="clock">--:--:--</span></h1>
<div id="temp-status">ÄŒekÃ¡m na dataâ€¦</div>

<div class="panel">

<!-- WIFI + GRAF -->
<div class="gauge">
  <div id="gauge-left" style="height:220px"></div>
  <div class="label">WiFi signÃ¡l [%]</div>

  <div class="history">
    <canvas id="historyChart"></canvas>
  </div>
</div>

<!-- STÅ˜ED -->
<div class="gauge big">
  <div id="gauge-center" style="height:280px"></div>
  <div class="label">Teplota v udÃ­rnÄ› [Â°C]</div>
</div>

<!-- VENEK -->
<div class="gauge">
  <div id="gauge-right" style="height:220px"></div>
  <div class="label">VenkovnÃ­ teplota [Â°C]</div>
</div>

</div>

<button id="fullscreen-btn" onclick="toggleFull()">Fullscreen</button>

<footer>
<div id="update-time">---</div>
</footer>

<script>
/* ==== KONFIG ==== */
const CHANNEL_MAIN="260804";
const CHANNEL_OUT="231269";

/* ==== GAUGE ==== */
const gWifi=new JustGage({id:"gauge-left",min:0,max:100,value:0});
const gCenter=new JustGage({id:"gauge-center",min:0,max:120,value:0});
const gOut=new JustGage({id:"gauge-right",min:-30,max:40,value:0});

/* ==== GRAF ==== */
let historyChart=null;

/* ==== DATA ==== */
async function loadData(){
  try{
    const r=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_MAIN}/feeds/last.json`);
    const d=await r.json();

    const temp=parseFloat(d.field1);
    const wifi=parseFloat(d.field2);

    if(!isNaN(temp)) gCenter.refresh(temp);
    if(!isNaN(wifi)) gWifi.refresh(wifi);

    const s=document.getElementById("temp-status");
    s.className="";
    if(temp<75){s.textContent="NÃ­zkÃ¡ teplota";s.classList.add("status-low")}
    else if(temp<=85){s.textContent="IdeÃ¡lnÃ­ teplota";s.classList.add("status-ok")}
    else{s.textContent="VysokÃ¡ teplota";s.classList.add("status-high")}

    document.getElementById("update-time").innerText=
      "Aktualizace: "+new Date(d.created_at).toLocaleString("cs-CZ");

    const r2=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_OUT}/feeds/last.json`);
    const d2=await r2.json();
    const out=parseFloat(d2.field4);
    if(!isNaN(out)) gOut.refresh(out);

  }catch(e){console.error(e)}
}

/* ==== HISTORIE 10h ==== */
async function loadHistory(){
  const r=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_MAIN}/feeds.json?results=600`);
  const d=await r.json();
  const labels=[],values=[];
  d.feeds.forEach(f=>{
    if(f.field1){
      labels.push(new Date(f.created_at).toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"}));
      values.push(parseFloat(f.field1));
    }
  });
  renderChart(labels,values);
}

function renderChart(l,v){
  const ctx=document.getElementById("historyChart");
  if(historyChart){
    historyChart.data.labels=l;
    historyChart.data.datasets[0].data=v;
    historyChart.update();
    return;
  }
  historyChart=new Chart(ctx,{
    type:"line",
    data:{labels:l,datasets:[{data:v,borderWidth:2,tension:.3,pointRadius:0}]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:"#aaa"},grid:{color:"#333"}},
        y:{ticks:{color:"#aaa"},grid:{color:"#333"}}
      }
    }
  });
}

/* ==== FULL ==== */
function toggleFull(){
  if(!document.fullscreenElement)
    document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

/* ==== CLOCK ==== */
setInterval(()=>clock.textContent=new Date().toLocaleTimeString("cs-CZ"),1000);

/* ==== START ==== */
loadData(); loadHistory();
setInterval(loadData,15000);
setInterval(loadHistory,300000);
</script>

</body>
</html>
