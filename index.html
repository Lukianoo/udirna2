<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Panel udÃ­rny</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- JustGage -->
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/justgage.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Tahoma,sans-serif;
  background:#121212;
  color:#fff;
  transition:background .4s;
  overflow:hidden; /* fullscreen bez scrollu */
}
h1.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:15px 30px;
  font-size:32px;
}
#clock{font-size:18px;opacity:.8}

#temp-status{
  text-align:center;
  font-size:28px;
  font-weight:bold;
  margin:0 30px 10px;
  padding:10px;
  border-radius:12px;
  background:linear-gradient(90deg,#222,#333);
}
.status-low{color:#3399ff}
.status-ok{color:#33cc33}
.status-high{color:#ff3333}

.panel{
  display:grid;
  grid-template-columns:1fr 1.5fr 1fr;
  gap:20px;
  padding:0 30px;
  max-width:1400px;
  margin:auto;
}

.gauge{
  background:#1e1e1e;
  border-radius:22px;
  padding:12px;
  text-align:center;
  box-shadow:0 4px 20px rgba(0,0,0,.6);
}
.gauge.big{transform:scale(1.1)}
.label{opacity:.85;font-size:14px}

/* graf pod wifi */
.history-small{
  margin-top:10px;
  background:#111;
  border-radius:12px;
  padding:6px;
}
.history-small canvas{
  width:100%!important;
  height:140px!important;
  display:block;
}

.alarm-settings{
  text-align:center;
  margin:10px 0;
  font-size:14px;
}
.alarm-settings input,
.alarm-settings select{
  width:65px;
  font-size:14px;
}
.alarm-settings button{
  padding:4px 10px;
  font-size:14px;
  margin-left:6px;
}

#fullscreen-btn{
  position:fixed;
  bottom:15px;
  right:15px;
  padding:8px 14px;
  font-size:14px;
}

footer{
  text-align:center;
  opacity:.6;
  font-size:13px;
  margin-top:6px;
}

@media(max-width:900px){
  body{overflow:auto}
  .panel{grid-template-columns:1fr}
  .gauge.big{transform:scale(1)}
}
</style>
</head>

<body>

<h1 class="header">ðŸ”¥ Panel udÃ­rny <span id="clock">--:--:--</span></h1>
<div id="temp-status">ÄŒekÃ¡m na dataâ€¦</div>

<div class="panel">

  <!-- WIFI + GRAF -->
  <div class="gauge">
    <div id="gauge-left" style="height:200px"></div>
    <div class="label">WiFi signÃ¡l [%]</div>

    <div class="history-small">
      <canvas id="historyChart"></canvas>
    </div>
  </div>

  <!-- STÅ˜ED -->
  <div class="gauge big">
    <div id="gauge-center" style="height:260px"></div>
    <div class="label">Teplota v udÃ­rnÄ› [Â°C]</div>
  </div>

  <!-- VENEK -->
  <div class="gauge">
    <div id="gauge-right" style="height:200px"></div>
    <div class="label">VenkovnÃ­ teplota [Â°C]</div>
  </div>

</div>

<div class="alarm-settings">
Min <input id="alarm-min" type="number"> Â°C
<select id="alarm-sound-min">
  <option value="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">Alarm</option>
  <option value="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">Beep</option>
</select>
Max <input id="alarm-max" type="number"> Â°C
<select id="alarm-sound-max">
  <option value="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">Alarm</option>
  <option value="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">Beep</option>
</select>
<button onclick="saveAlarm()">UloÅ¾it</button>
<button onclick="testAlarm()">Test</button>
</div>

<button id="fullscreen-btn" type="button" onclick="toggleFull()">Full</button>

<footer>
  <div id="update-time">---</div>
</footer>

<script>
/* ==== KONFIG ==== */
const CHANNEL_MAIN="260804";
const CHANNEL_OUT="231269";

/* ==== GAUGE ==== */
const gaugeLeft=new JustGage({id:"gauge-left",min:0,max:100,value:0});
const gaugeCenter=new JustGage({id:"gauge-center",min:0,max:120,value:0});
const gaugeRight=new JustGage({id:"gauge-right",min:-30,max:40,value:0});

/* ==== ALARM ==== */
let alarmActive=false;
let alarmMin=0,alarmMax=120;
let alarmSoundMin,alarmSoundMax;

/* ==== GRAF ==== */
let historyChart=null;

/* ==== ELEMENTY ==== */
const alarmMinInput=document.getElementById("alarm-min");
const alarmMaxInput=document.getElementById("alarm-max");
const alarmSoundMinSelect=document.getElementById("alarm-sound-min");
const alarmSoundMaxSelect=document.getElementById("alarm-sound-max");

/* ==== ALARM STORAGE ==== */
function loadSavedAlarm(){
  const s=localStorage.getItem("alarm");
  if(!s)return;
  const a=JSON.parse(s);
  alarmMin=a.min; alarmMax=a.max;
  alarmSoundMin=a.smin; alarmSoundMax=a.smax;
  alarmMinInput.value=alarmMin;
  alarmMaxInput.value=alarmMax;
  alarmSoundMinSelect.value=alarmSoundMin;
  alarmSoundMaxSelect.value=alarmSoundMax;
}
function saveAlarm(){
  alarmMin=+alarmMinInput.value;
  alarmMax=+alarmMaxInput.value;
  alarmSoundMin=alarmSoundMinSelect.value;
  alarmSoundMax=alarmSoundMaxSelect.value;
  localStorage.setItem("alarm",JSON.stringify({
    min:alarmMin,max:alarmMax,smin:alarmSoundMin,smax:alarmSoundMax
  }));
}
function play(s){new Audio(s).play()}
function testAlarm(){play(alarmSoundMin);setTimeout(()=>play(alarmSoundMax),1000)}

/* ==== DATA ==== */
async function loadData(){
  try{
    const r1=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_MAIN}/feeds/last.json`);
    const d1=await r1.json();
    const temp=parseFloat(d1.field1);
    const wifi=parseFloat(d1.field2);
    gaugeCenter.refresh(temp);
    gaugeLeft.refresh(wifi);

    const r2=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_OUT}/feeds/last.json`);
    const d2=await r2.json();
    gaugeRight.refresh(parseFloat(d2.field4));

    document.getElementById("update-time").innerText=
      "PoslednÃ­ aktualizace: "+new Date(d1.created_at).toLocaleString("cs-CZ");

    const st=document.getElementById("temp-status");
    st.className="";
    if(temp<alarmMin){
      st.innerText="NÃ­zkÃ¡ teplota";
      st.classList.add("status-low");
      document.body.style.background="#001a33";
      if(!alarmActive){play(alarmSoundMin);alarmActive=true;}
    }else if(temp>alarmMax){
      st.innerText="VysokÃ¡ teplota!";
      st.classList.add("status-high");
      document.body.style.background="#2b0000";
      if(!alarmActive){play(alarmSoundMax);alarmActive=true;}
    }else{
      st.innerText="IdeÃ¡lnÃ­ teplota";
      st.classList.add("status-ok");
      document.body.style.background="#121212";
      alarmActive=false;
    }
  }catch{
    document.getElementById("temp-status").innerText="âš ï¸ Data nedostupnÃ¡";
    alarmActive=false;
  }
}

/* ==== HISTORIE 10H ==== */
async function loadHistory(){
  try{
    const r=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_MAIN}/feeds.json?results=600`);
    const d=await r.json();
    const labels=[],values=[];
    d.feeds.forEach(f=>{
      if(f.field1){
        labels.push(new Date(f.created_at).toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"}));
        values.push(parseFloat(f.field1));
      }
    });
    renderChart(labels,values);
  }catch{}
}
function renderChart(labels,values){
  const ctx=document.getElementById("historyChart").getContext("2d");
  if(historyChart){
    historyChart.data.labels=labels;
    historyChart.data.datasets[0].data=values;
    historyChart.update();
    return;
  }
  historyChart=new Chart(ctx,{
    type:"line",
    data:{labels,datasets:[{
      label:"Teplota [Â°C]",
      data:values,
      borderWidth:2,
      tension:.25,
      pointRadius:0
    }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:"#aaa"},grid:{color:"#333"}},
        y:{ticks:{color:"#aaa"},grid:{color:"#333"}}
      }
    }
  });
}

/* ==== FULLSCREEN ==== */
function toggleFull(){
  const d=document,e=document.documentElement;
  if(!d.fullscreenElement&&!d.webkitFullscreenElement){
    e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen();
  }else{
    d.exitFullscreen?d.exitFullscreen():d.webkitExitFullscreen();
  }
}

/* ==== CLOCK ==== */
function clock(){
  document.getElementById("clock").innerText=
    new Date().toLocaleTimeString("cs-CZ");
}

/* ==== START ==== */
loadSavedAlarm();
loadData(); loadHistory();
setInterval(loadData,15000);
setInterval(loadHistory,300000);
clock(); setInterval(clock,1000);
</script>

</body>
</html>
